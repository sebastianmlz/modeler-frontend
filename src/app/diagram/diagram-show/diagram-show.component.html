<app-diagram-collaboration
	[diagramId]="diagramId"
	[token]="token"
	(eventReceived)="onCollabEvent($event)"
	(statusChanged)="onCollabStatus($event)"
	(activeMembersChanged)="onActiveMembersChanged($event)"
	#collabComp>
</app-diagram-collaboration>
<div style="position: fixed; top: 48px; left: 0; width: 100%; background: #f8fafc; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0.7rem 2rem 0.7rem 1.5rem; z-index: 200; height: 56px; box-sizing: border-box;">
	<div style="display: flex; align-items: center; gap: 1.5rem;">
		<span style="font-size: 1.15rem; font-weight: 600; color: #222; letter-spacing: 0.5px;">Diagrama UML</span>
		<!-- Aqu√≠ puedes agregar el nombre del diagrama si lo tienes -->
	</div>
	<div style="display: flex; align-items: center; gap: 1.2rem;">
		<!-- Miembros del proyecto (del backend) con indicador de conexi√≥n -->
		<div style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1.5rem;">
			<ng-container *ngIf="collabMembers && collabMembers.length > 0">
				<span style="font-size: 0.97rem; color: #555; font-weight: 500; margin-right: 0.7rem;">Miembros del proyecto:</span>
				<span *ngFor="let member of collabMembers" style="display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; align-items: center;">
					<!-- Punto de estado: verde si activo, gris si no -->
					<span 
						[style.background]="member.isActive ? '#22c55e' : '#e0e7ef'" 
						style="width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc; margin-right: 0.2rem;"></span>
					<span style="font-size: 0.98rem; color: #222; font-weight: 500;">{{member.username}}</span>
				</span>
			</ng-container>
			<ng-container *ngIf="!collabMembers || collabMembers.length === 0">
				<span style="color: #888; font-size: 0.98rem;">Sin miembros</span>
			</ng-container>
		</div>
		<!-- Miembros conectados en tiempo real (si tienes l√≥gica para diferenciarlos, puedes mostrar otra lista aqu√≠) -->
		<!-- ... -->
		<button (click)="toggleAISuggestions()" 
			[style.background]="showAISuggestions ? '#7c3aed' : '#8b5cf6'" 
			style="color: #fff; border: none; border-radius: 4px; padding: 0.45rem 1.3rem; font-weight: 500; font-size: 1rem; cursor: pointer; transition: background 0.2s;">
			ü§ñ {{ showAISuggestions ? 'Ocultar' : 'Sugerencias' }} IA
		</button>
		<button (click)="toggleVoicePrompt()" 
			[style.background]="showVoicePrompt ? '#dc2626' : '#ef4444'" 
			style="color: #fff; border: none; border-radius: 4px; padding: 0.45rem 1.3rem; font-weight: 500; font-size: 1rem; cursor: pointer; transition: background 0.2s;">
			üéôÔ∏è {{ showVoicePrompt ? 'Ocultar' : 'Comando' }} Voz
		</button>
		<button (click)="saveDiagramVersion()" style="background: #2563eb; color: #fff; border: none; border-radius: 4px; padding: 0.45rem 1.3rem; font-weight: 500; font-size: 1rem; cursor: pointer;">Guardar versi√≥n</button>
		<button (click)="exportSpringBootBackend()" style="background: #059669; color: #fff; border: none; border-radius: 4px; padding: 0.45rem 1.3rem; font-weight: 500; font-size: 1rem; cursor: pointer;">Descargar backend spring boot</button>
	</div>
</div>
<!-- El contenido principal ahora tiene padding-top para no quedar debajo de la barra -->
<div style="display: flex; height: 100vh; padding-top: 104px; box-sizing: border-box;">
	<!-- Sidebar a la izquierda -->
	<div style="width: 260px; background: #f3f4f6; border-right: 1px solid #e5e7eb; padding: 0.5rem 0;">
		<app-show-sidebar (addClass)="addNewClass()" (selectRelation)="onRelationSelected($event)"></app-show-sidebar>
	</div>
	<!-- Diagramador principal -->
	<div style="flex: 1; display: flex; flex-direction: column; position: relative;">
		<ejs-diagram
			#umlDiagram
			id="umlDiagram"
			width="100%"
			height="calc(100vh - 0px)"
			[nodes]="nodes"
			[connectors]="connectors"
			[selectedItems]="selectedItems"
			(selectionChange)="onSelectionChange($event)"
			(dragStop)="onElementMoved($event)"
			(propertyChange)="onPropertyChange($event)"
			(created)="onDiagramCreated($event)">
		</ejs-diagram>
		<!-- Panel lateral de edici√≥n de clase -->
		<div *ngIf="selectedUMLClass" style="position: absolute; top: 0; right: 0; height: 100%; width: 380px; background: #fff; box-shadow: -2px 0 8px #0001; z-index: 50; padding: 1.5rem; overflow-y: auto; border-left: 1px solid #e5e7eb;">
			<h2 style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Editar Clase</h2>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Nombre de la clase</label>
				<input type="text" [(ngModel)]="selectedUMLClass.name" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;" />
			</div>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Visibilidad</label>
				<select [(ngModel)]="selectedUMLClass.visibility" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
					<option value="PUBLIC">P√∫blica</option>
					<option value="PRIVATE">Privada</option>
					<option value="PROTECTED">Protegida</option>
				</select>
			</div>
			<h3 style="font-weight: 600; margin-bottom: 0.5rem;">Atributos</h3>
			<div *ngFor="let attr of selectedUMLClass.attributes; let i = index" style="margin-bottom: 0.7rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
				<div style="display: flex; gap: 0.5rem; align-items: center;">
					<input type="text" [(ngModel)]="attr.name" placeholder="Nombre" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 90px;" />
					<select [(ngModel)]="attr.typeName" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 80px;">
						<option *ngFor="let t of attributeTypes" [value]="t">{{t}}</option>
					</select>
					<label style="display: flex; align-items: center; gap: 0.2rem; font-size: 0.95rem;">
						<input type="checkbox" [(ngModel)]="attr.isRequired" /> Obligatorio
					</label>
					<label style="display: flex; align-items: center; gap: 0.2rem; font-size: 0.95rem;">
						<input type="radio" name="pkRadio{{selectedUMLClass.id}}" [checked]="attr.isPrimaryKey" (change)="setPrimaryKey(i)" [disabled]="attr.isPrimaryKey || hasPrimaryKey && !attr.isPrimaryKey" /> PK
					</label>
					<button (click)="removeAttribute(i)" style="color: #e11d48; background: none; border: none; cursor: pointer; margin-left: 0.5rem;">Eliminar</button>
				</div>
				<div *ngIf="attributeNameExists(attr.name, i)" style="font-size: 0.85rem; color: #e11d48; margin-top: 0.2rem;">Nombre repetido</div>
			</div>
			<button (click)="addAttribute()" style="margin-top: 0.5rem; padding: 0.3rem 1.2rem; background: #2563eb; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Agregar atributo</button>
			<!-- Bot√≥n para actualizar la clase en el canvas -->
			<button (click)="updateSelectedClassOnCanvas()" style="margin-top: 0.5rem; margin-left: 0.5rem; padding: 0.3rem 1.2rem; background: #059669; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Actualizar clase</button>
			<button (click)="closeClassPanel()" style="position: absolute; top: 0.7rem; right: 0.7rem; color: #888; background: none; border: none; font-size: 1.3rem; cursor: pointer;">‚úï</button>
		</div>

        <!-- Panel lateral de edici√≥n de relaci√≥n -->
        <div *ngIf="showRelationSidebar && editingRelation" style="position: absolute; top: 0; right: 0; height: 100%; width: 380px; background: #fff; box-shadow: -2px 0 8px #0001; z-index: 51; padding: 1.5rem; overflow-y: auto; border-left: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Editar Relaci√≥n</h2>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.95rem; font-weight: 500;">Nombre de la relaci√≥n</label>
                <input type="text" [(ngModel)]="editingRelation.name" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;" />
            </div>
			<div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
				<div style="flex:1;">
					<label style="display: block; font-size: 0.95rem; font-weight: 500;">Multiplicidad Origen</label>
					<select [(ngModel)]="editingRelation.sourceMultiplicity" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
						<option value="1">1</option>
						<option value="0..1">0..1</option>
						<option value="*">*</option>
						<option value="1..*">1..*</option>
					</select>
				</div>
				<div style="flex:1;">
					<label style="display: block; font-size: 0.95rem; font-weight: 500;">Multiplicidad Destino</label>
					<select [(ngModel)]="editingRelation.targetMultiplicity" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
						<option value="1">1</option>
						<option value="0..1">0..1</option>
						<option value="*">*</option>
						<option value="1..*">1..*</option>
					</select>
				</div>
			</div>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Tipo de relaci√≥n</label>
				<div style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem; background: #f3f4f6; color: #444;">
				  {{ editingRelation.type }}
				</div>
			</div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.95rem; font-weight: 500;">Clase de Asociaci√≥n (para N a N)</label>
                <select [(ngModel)]="editingRelation.associationClassId" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
                    <option [ngValue]="null">Ninguna</option>
                    <option *ngFor="let c of umlClasses" [ngValue]="c.id">{{c.name}}</option>
                </select>
            </div>
            <button (click)="saveRelationEdit()" style="margin-top: 0.5rem; padding: 0.3rem 1.2rem; background: #059669; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Guardar cambios</button>
            <button (click)="closeRelationPanel()" style="margin-top: 0.5rem; margin-left: 0.5rem; padding: 0.3rem 1.2rem; background: #e11d48; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Cancelar</button>
        </div>
		<!-- Bot√≥n flotante para eliminar relaci√≥n -->
		<button *ngIf="selectedUMLRelationId" (click)="deleteSelectedRelation()" style="position: absolute; top: 20px; right: 30px; z-index: 100; background: #e11d48; color: #fff; border: none; border-radius: 4px; padding: 0.5rem 1.2rem; font-weight: 500; cursor: pointer;">Eliminar relaci√≥n</button>
		
		<!-- Bot√≥n flotante para eliminar clase -->
		<button *ngIf="selectedUMLClass && !selectedUMLRelationId" (click)="deleteSelectedClass()" style="position: absolute; top: 20px; right: 30px; z-index: 100; background: #dc2626; color: #fff; border: none; border-radius: 4px; padding: 0.5rem 1.2rem; font-weight: 500; cursor: pointer;">Eliminar clase</button>
		
		<!-- Panel de Sugerencias de IA -->
		<div *ngIf="showAISuggestions" style="position: absolute; top: 0; right: 0; height: 100%; width: 420px; background: #fff; box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15); z-index: 100; overflow: hidden; border-left: 1px solid #e5e7eb;">
			<div style="height: 100%; display: flex; flex-direction: column;">
				<!-- Header del panel -->
				<div style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f8fafc; flex-shrink: 0;">
					<div style="display: flex; align-items: center; justify-content: space-between;">
						<h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">ü§ñ Sugerencias de IA</h3>
						<button (click)="toggleAISuggestions()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">‚úï</button>
					</div>
					<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #6b7280;">An√°lisis inteligente de tu diagrama UML</p>
				</div>
				
				<!-- Contenido de sugerencias -->
				<div style="flex: 1; overflow: hidden;">
					<app-diagram-ai-suggestions
						#aiSuggestionsComp
						[diagramSnapshot]="currentSnapshot"
						[autoRefreshInterval]="15000"
						(applySuggestion)="onApplySuggestion($event)"
						(applyAllSuggestions)="onApplyAllSuggestions($event)"
						style="height: 100%; display: block; overflow-y: auto;">
					</app-diagram-ai-suggestions>
				</div>
			</div>
		</div>

		<!-- Panel de Comandos de Voz -->
		<div *ngIf="showVoicePrompt" style="position: absolute; top: 0; right: 0; height: 100%; width: 420px; background: #fff; box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15); z-index: 100; overflow: hidden; border-left: 1px solid #e5e7eb;">
			<div style="height: 100%; display: flex; flex-direction: column;">
				<!-- Header del panel -->
				<div style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background: #fef2f2; flex-shrink: 0;">
					<div style="display: flex; align-items: center; justify-content: space-between;">
						<h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">üéôÔ∏è Comandos de Voz</h3>
						<button (click)="toggleVoicePrompt()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">‚úï</button>
					</div>
					<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #6b7280;">Crea y modifica tu diagrama UML hablando</p>
				</div>
				
				<!-- Contenido de comandos de voz -->
				<div style="flex: 1; overflow: hidden;">
					<app-diagram-ai-prompt
						#aiPromptComp
						[diagramSnapshot]="currentSnapshot"
						(applyVoiceCommand)="onApplyVoiceChanges($event)"
						style="height: 100%; display: block; overflow-y: auto;">
					</app-diagram-ai-prompt>
				</div>
			</div>
		</div>
	</div>
</div>