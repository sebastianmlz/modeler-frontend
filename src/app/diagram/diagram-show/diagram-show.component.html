<app-diagram-collaboration
  [diagramId]="diagramId"
  [token]="token"
  (eventReceived)="onCollabEvent($event)"
  (statusChanged)="onCollabStatus($event)"
  (activeMembersChanged)="onActiveMembersChanged($event)"
  #collabComp>
</app-diagram-collaboration>
<div style="width: 100%; background: #f8fafc; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0.7rem 2rem 0.7rem 1.5rem; height: 56px; box-sizing: border-box;">
	<div style="display: flex; align-items: center; gap: 1.5rem;">
		<span style="font-size: 1.15rem; font-weight: 600; color: #222; letter-spacing: 0.5px;">Diagrama UML</span>
		<!-- Aquí puedes agregar el nombre del diagrama si lo tienes -->
	</div>
	<div style="display: flex; align-items: center; gap: 1.2rem;">
		<!-- Miembros del proyecto (del backend) con indicador de conexión -->
		<div style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1.5rem;">
			<ng-container *ngIf="collabMembers && collabMembers.length > 0">
				<span style="font-size: 0.97rem; color: #555; font-weight: 500; margin-right: 0.7rem;">Miembros del proyecto:</span>
				<span *ngFor="let member of collabMembers" style="display: flex; align-items: center; gap: 0.3rem; margin-right: 0.5rem; align-items: center;">
					<!-- Punto de estado: verde si activo, gris si no -->
					<span 
						[style.background]="member.isActive ? '#22c55e' : '#e0e7ef'" 
						style="width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc; margin-right: 0.2rem;"></span>
					<span style="font-size: 0.98rem; color: #222; font-weight: 500;">{{member.username}}</span>
				</span>
			</ng-container>
			<ng-container *ngIf="!collabMembers || collabMembers.length === 0">
				<span style="color: #888; font-size: 0.98rem;">Sin miembros</span>
			</ng-container>
		</div>
		<!-- Miembros conectados en tiempo real (si tienes lógica para diferenciarlos, puedes mostrar otra lista aquí) -->
		<!-- ... -->
			<button (click)="toggleAISuggestions()" 
				[style.background]="showAISuggestions ? '#7c3aed' : '#8b5cf6'" 
				style="color: #fff; border: none; border-radius: 4px; padding: 0.28rem 0.85rem; font-weight: 500; font-size: 0.93rem; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 0.4rem; min-width: 0;">
				<i class="pi pi-android"></i> {{ showAISuggestions ? 'Ocultar' : 'Sugerencias' }} IA
			</button>
			<button (click)="toggleVoicePrompt()" 
				[style.background]="showVoicePrompt ? '#dc2626' : '#ef4444'" 
				style="color: #fff; border: none; border-radius: 4px; padding: 0.28rem 0.85rem; font-weight: 500; font-size: 0.93rem; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 0.4rem; min-width: 0;">
				<i class="pi pi-microphone"></i> {{ showVoicePrompt ? 'Ocultar' : 'Comando' }} Voz
			</button>
			<button (click)="showInviteModal()" 
				style="background: #f59e0b; color: #fff; border: none; border-radius: 4px; padding: 0.28rem 0.85rem; font-weight: 500; font-size: 0.93rem; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 0.4rem; min-width: 0;">
				<i class="pi pi-share-alt"></i> Invitar
			</button>
			<button (click)="saveDiagramVersion()" style="background: #2563eb; color: #fff; border: none; border-radius: 4px; padding: 0.28rem 0.85rem; font-weight: 500; font-size: 0.93rem; cursor: pointer; min-width: 0;">Guardar versión</button>
			<button (click)="exportSpringBootBackend()" style="background: #059669; color: #fff; border: none; border-radius: 4px; padding: 0.28rem 0.85rem; font-weight: 500; font-size: 0.93rem; cursor: pointer; min-width: 0;">Descargar backend spring boot</button>
	</div>
</div>

<!-- Modal de invitación para usuarios no miembros -->
<div *ngIf="showInvitationModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
	<div style="background: #fff; border-radius: 8px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);">
		<div style="text-align: center; margin-bottom: 1.5rem;">
			<div style="width: 64px; height: 64px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
				<svg style="width: 32px; height: 32px; color: white;" fill="currentColor" viewBox="0 0 20 20">
					<path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
				</svg>
			</div>
			<h2 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin: 0 0 0.5rem 0;">Invitación al Proyecto</h2>
			<p style="color: #6b7280; margin: 0; line-height: 1.5;">Has sido invitado a colaborar en este proyecto UML. ¿Te gustaría unirte como miembro?</p>
		</div>
		
		<div *ngIf="joiningProject" style="text-align: center; margin: 1rem 0;">
			<div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
			<p style="color: #6b7280; margin: 0.5rem 0 0 0;">Procesando invitación...</p>
		</div>
		
		<div *ngIf="!joiningProject" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
			<button 
				(click)="declineInvitation()"
				style="flex: 1; padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.15s;">
				No, gracias
			</button>
			<button 
				(click)="acceptInvitation()"
				style="flex: 1; padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.15s;">
				Aceptar y unirme
			</button>
		</div>
	</div>
</div>

<!-- Modal para copiar URL de invitación -->
<div *ngIf="showInviteUrlModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
	<div style="background: #fff; border-radius: 8px; padding: 2rem; max-width: 600px; width: 90%; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);">
		<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
			<i class="pi pi-share-alt" style="color: #f59e0b; font-size: 1.25rem;"></i>
			<h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #1f2937;">Invitar al proyecto</h3>
		</div>
		
		<p style="margin: 0 0 1.5rem 0; color: #6b7280; line-height: 1.5;">
			Comparte esta URL para invitar a otros usuarios a colaborar en este diagrama UML:
		</p>
		
		<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
			<input 
				#inviteUrlInput
				type="text" 
				[value]="currentInviteUrl" 
				readonly 
				style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.95rem; background: #f9fafb; color: #374151; font-family: monospace;">
			<button 
				(click)="copyInviteUrl(inviteUrlInput)"
				style="padding: 0.75rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.15s; display: flex; align-items: center; gap: 0.5rem;">
				<i class="pi pi-copy"></i>
				{{ urlCopied ? 'Copiado!' : 'Copiar' }}
			</button>
		</div>
		
		<div style="display: flex; gap: 1rem; justify-content: flex-end;">
			<button 
				(click)="closeInviteModal()"
				style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.15s;">
				Cerrar
			</button>
		</div>
	</div>
</div>

<style>
@keyframes spin {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}
</style>
<!-- El contenido principal -->
<div style="display: flex; height: calc(100vh - 56px); box-sizing: border-box;">
	<!-- Sidebar a la izquierda -->
	<div style="width: 260px; background: #f3f4f6; border-right: 1px solid #e5e7eb; padding: 0.5rem 0;">
		<app-show-sidebar (addClass)="addNewClass($event)" (selectRelation)="onRelationSelected($event)"></app-show-sidebar>
	</div>
	<!-- Diagramador principal -->
	<div style="flex: 1; display: flex; flex-direction: column; position: relative;">
		<ejs-diagram
			#umlDiagram
			id="umlDiagram"
			width="100%"
			height="calc(100vh - 0px)"
			[nodes]="nodes"
			[connectors]="connectors"
			[selectedItems]="selectedItems"
			(selectionChange)="onSelectionChange($event)"
			(dragStop)="onElementMoved($event)"
			(propertyChange)="onPropertyChange($event)"
			(created)="onDiagramCreated($event)">
		</ejs-diagram>
		<!-- Panel lateral de edición de clase -->
		<div *ngIf="selectedUMLClass" style="position: absolute; top: 0; right: 0; height: 100%; width: 380px; background: #fff; box-shadow: -2px 0 8px #0001; z-index: 50; padding: 1.5rem; overflow-y: auto; border-left: 1px solid #e5e7eb;">
			<h2 style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Editar Clase</h2>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Nombre de la clase</label>
				<input type="text" [(ngModel)]="selectedUMLClass.name" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;" />
			</div>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Visibilidad</label>
				<select [(ngModel)]="selectedUMLClass.visibility" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
					<option value="PUBLIC">Pública</option>
					<option value="PRIVATE">Privada</option>
					<option value="PROTECTED">Protegida</option>
				</select>
			</div>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Tipo de Clase</label>
				<select [(ngModel)]="selectedUMLClass.classType" (ngModelChange)="onClassTypeChange($event)" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
					<option value="CLASS">Clase</option>
					<option value="INTERFACE">Interface</option>
					<option value="ABSTRACT_CLASS">Clase Abstracta</option>
				</select>
			</div>
			<h3 style="font-weight: 600; margin-bottom: 0.5rem;">Atributos</h3>
			<div *ngFor="let attr of selectedUMLClass.attributes; let i = index" style="margin-bottom: 0.7rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
				<div style="display: flex; gap: 0.5rem; align-items: center;">
					<input type="text" [(ngModel)]="attr.name" placeholder="Nombre" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 90px;" />
					<select [(ngModel)]="attr.typeName" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 80px;">
						<option *ngFor="let t of attributeTypes" [value]="t">{{t}}</option>
					</select>
					<label style="display: flex; align-items: center; gap: 0.2rem; font-size: 0.95rem;">
						<input type="checkbox" [(ngModel)]="attr.isRequired" /> Obligatorio
					</label>
					<label style="display: flex; align-items: center; gap: 0.2rem; font-size: 0.95rem;">
						<input type="radio" name="pkRadio{{selectedUMLClass.id}}" [checked]="attr.isPrimaryKey" (change)="setPrimaryKey(i)" [disabled]="attr.isPrimaryKey || hasPrimaryKey && !attr.isPrimaryKey" /> PK
					</label>
					<button (click)="removeAttribute(i)" style="color: #e11d48; background: none; border: none; cursor: pointer; margin-left: 0.5rem;">Eliminar</button>
				</div>
				<div *ngIf="attributeNameExists(attr.name, i)" style="font-size: 0.85rem; color: #e11d48; margin-top: 0.2rem;">Nombre repetido</div>
			</div>
			<button (click)="addAttribute()" style="margin-top: 0.5rem; padding: 0.3rem 1.2rem; background: #2563eb; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Agregar atributo</button>
			
			<!-- Sección de métodos comentada por petición del usuario -->
			<!-- 
			<h3 style="font-weight: 600; margin-bottom: 0.5rem; margin-top: 1.5rem;">Métodos</h3>
			<div *ngFor="let method of selectedUMLClass.methods || []; let i = index" style="margin-bottom: 0.7rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem;">
				<div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.3rem;">
					<input type="text" [(ngModel)]="method.name" placeholder="Nombre método" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 120px;" />
					<select [(ngModel)]="method.returnType" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 80px;">
						<option *ngFor="let t of attributeTypes" [value]="t">{{t}}</option>
						<option value="void">void</option>
					</select>
					<select [(ngModel)]="method.visibility" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.2rem 0.5rem; width: 80px;">
						<option value="PUBLIC">Público</option>
						<option value="PRIVATE">Privado</option>
						<option value="PROTECTED">Protegido</option>
					</select>
					<button (click)="removeMethod(i)" style="color: #e11d48; background: none; border: none; cursor: pointer;">Eliminar</button>
				</div>
				<div style="margin-left: 0.5rem;">
					<h4 style="font-size: 0.9rem; margin: 0.3rem 0;">Parámetros:</h4>
					<div *ngFor="let param of method.parameters || []; let j = index" style="display: flex; gap: 0.3rem; align-items: center; margin-bottom: 0.2rem;">
						<input type="text" [(ngModel)]="param.name" placeholder="Nombre param" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.1rem 0.3rem; width: 80px; font-size: 0.85rem;" />
						<select [(ngModel)]="param.typeName" style="border: 1px solid #ccc; border-radius: 4px; padding: 0.1rem 0.3rem; width: 70px; font-size: 0.85rem;">
							<option *ngFor="let t of attributeTypes" [value]="t">{{t}}</option>
						</select>
						<button (click)="removeParameter(i, j)" style="color: #e11d48; background: none; border: none; cursor: pointer; font-size: 0.8rem;">×</button>
					</div>
					<button (click)="addParameter(i)" style="font-size: 0.8rem; padding: 0.1rem 0.5rem; background: #6366f1; color: #fff; border-radius: 3px; border: none; font-weight: 500; cursor: pointer;">+ Parámetro</button>
				</div>
			</div>
			<button (click)="addMethod()" style="margin-top: 0.5rem; padding: 0.3rem 1.2rem; background: #7c3aed; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Agregar método</button>
			-->
			
			<!-- Botón para actualizar la clase en el canvas -->
			<button (click)="updateSelectedClassOnCanvas()" style="margin-top: 0.5rem; margin-left: 0.5rem; padding: 0.3rem 1.2rem; background: #059669; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Actualizar clase</button>
			<button (click)="closeClassPanel()" style="position: absolute; top: 0.7rem; right: 0.7rem; color: #888; background: none; border: none; font-size: 1.3rem; cursor: pointer;">✕</button>
		</div>

        <!-- Panel lateral de edición de relación -->
        <div *ngIf="showRelationSidebar && editingRelation" style="position: absolute; top: 0; right: 0; height: 100%; width: 380px; background: #fff; box-shadow: -2px 0 8px #0001; z-index: 51; padding: 1.5rem; overflow-y: auto; border-left: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Editar Relación</h2>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.95rem; font-weight: 500;">Nombre de la relación</label>
                <input type="text" [(ngModel)]="editingRelation.name" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;" />
            </div>
			<div style="margin-bottom: 1rem; display: flex; gap: 1rem;">
				<div style="flex:1;">
					<label style="display: block; font-size: 0.95rem; font-weight: 500;">Multiplicidad Origen</label>
					<select [(ngModel)]="editingRelation.sourceMultiplicity" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
						<option value="1">1</option>
						<option value="0..1">0..1</option>
						<option value="*">*</option>
						<option value="1..*">1..*</option>
					</select>
				</div>
				<div style="flex:1;">
					<label style="display: block; font-size: 0.95rem; font-weight: 500;">Multiplicidad Destino</label>
					<select [(ngModel)]="editingRelation.targetMultiplicity" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
						<option value="1">1</option>
						<option value="0..1">0..1</option>
						<option value="*">*</option>
						<option value="1..*">1..*</option>
					</select>
				</div>
			</div>
			<div style="margin-bottom: 1rem;">
				<label style="display: block; font-size: 0.95rem; font-weight: 500;">Tipo de relación</label>
				<div style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem; background: #f3f4f6; color: #444;">
				  {{ editingRelation.type }}
				</div>
			</div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-size: 0.95rem; font-weight: 500;">Clase de Asociación (para N a N)</label>
                <select [(ngModel)]="editingRelation.associationClassId" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 0.3rem 0.5rem; margin-top: 0.3rem;">
                    <option [ngValue]="null">Ninguna</option>
                    <option *ngFor="let c of umlClasses" [ngValue]="c.id">{{c.name}}</option>
                </select>
            </div>
            <button (click)="saveRelationEdit()" style="margin-top: 0.5rem; padding: 0.3rem 1.2rem; background: #059669; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Guardar cambios</button>
            <button (click)="closeRelationPanel()" style="margin-top: 0.5rem; margin-left: 0.5rem; padding: 0.3rem 1.2rem; background: #e11d48; color: #fff; border-radius: 4px; border: none; font-weight: 500; cursor: pointer;">Cancelar</button>
        </div>
		<!-- Botón flotante para eliminar relación -->
		<button *ngIf="selectedUMLRelationId" (click)="deleteSelectedRelation()" style="position: absolute; top: 20px; right: 30px; z-index: 100; background: #e11d48; color: #fff; border: none; border-radius: 4px; padding: 0.5rem 1.2rem; font-weight: 500; cursor: pointer;">Eliminar relación</button>
		
		<!-- Botón flotante para eliminar clase -->
		<button *ngIf="selectedUMLClass && !selectedUMLRelationId" (click)="deleteSelectedClass()" style="position: absolute; top: 20px; right: 30px; z-index: 100; background: #dc2626; color: #fff; border: none; border-radius: 4px; padding: 0.5rem 1.2rem; font-weight: 500; cursor: pointer;">Eliminar clase</button>
		
		<!-- Panel de Sugerencias de IA -->
		<div *ngIf="showAISuggestions" style="position: absolute; top: 0; right: 0; height: 100%; width: 420px; background: #fff; box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15); z-index: 100; overflow: hidden; border-left: 1px solid #e5e7eb;">
			<div style="height: 100%; display: flex; flex-direction: column;">
				<!-- Header del panel -->
				<div style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background: #f8fafc; flex-shrink: 0;">
					<div style="display: flex; align-items: center; justify-content: space-between;">
						<h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">🤖 Sugerencias de IA</h3>
						<button (click)="toggleAISuggestions()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">✕</button>
					</div>
					<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #6b7280;">Análisis inteligente de tu diagrama UML</p>
				</div>
				
				<!-- Contenido de sugerencias -->
				<div style="flex: 1; overflow: hidden;">
					<app-diagram-ai-suggestions
						#aiSuggestionsComp
						[diagramSnapshot]="currentSnapshot"
						[autoRefreshInterval]="15000"
						(applySuggestion)="onApplySuggestion($event)"
						(applyAllSuggestions)="onApplyAllSuggestions($event)"
						style="height: 100%; display: block; overflow-y: auto;">
					</app-diagram-ai-suggestions>
				</div>
			</div>
		</div>

		<!-- Panel de Comandos de Voz -->
		<div *ngIf="showVoicePrompt" style="position: absolute; top: 0; right: 0; height: 100%; width: 420px; background: #fff; box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15); z-index: 100; overflow: hidden; border-left: 1px solid #e5e7eb;">
			<div style="height: 100%; display: flex; flex-direction: column;">
				<!-- Header del panel -->
				<div style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background: #fef2f2; flex-shrink: 0;">
					<div style="display: flex; align-items: center; justify-content: space-between;">
						<h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">🎙️ Comandos de Voz</h3>
						<button (click)="toggleVoicePrompt()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem;">✕</button>
					</div>
					<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #6b7280;">Crea y modifica tu diagrama UML hablando</p>
				</div>
				
				<!-- Contenido de comandos de voz -->
				<div style="flex: 1; overflow: hidden;">
					<app-diagram-ai-prompt
						#aiPromptComp
						[diagramSnapshot]="currentSnapshot"
						(applyVoiceCommand)="onApplyVoiceChanges($event)"
						style="height: 100%; display: block; overflow-y: auto;">
					</app-diagram-ai-prompt>
				</div>
			</div>
		</div>
	</div>
</div>